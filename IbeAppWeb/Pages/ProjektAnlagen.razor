@page "/project-anlage"
@using IbeAppWeb.DTOs
@using IbeAppWeb.Services
@inject ProjectAnlageService ProjectAnlageService
@inject ProjectService ProjectService

<h3>Project Anlage Management</h3>

<label for="projectSelect">Select Project:</label>
<select id="projectSelect" @bind="projectId">
    @foreach (var project in projects)
    {
        <option value="@project.ProjectId">@project.ProjectName</option>
    }
</select>

<label for="existingAnlageSelect">Bestehende Anlage:</label>
<select id="existingAnlageSelect" @bind="anlageId">
    @foreach (var anlage in anlagenList)
    {
        <option value="@anlage.AnlageId">@anlage.AnlageName</option>
    }
</select>

<label for="newAnlageSelect">Neue Anlage:</label>
<select id="newAnlageSelect" @bind="anlageId">
    @foreach (var anlage in anlagenList)
    {
        <option value="@anlage.AnlageId">@anlage.AnlageName</option>
    }
</select>

<button @onclick="AssignAnlage">Anlage Zuordnen</button>
<button @onclick="UpdateAnlage">Update Zuordnung</button>
<button @onclick="RemoveAnlage">Lösche Zuordnung</button>
<button @onclick="GetProjectAnlage">Zeige Anlagen</button>
<button @onclick="GetAllProjectAnlagen">Zeige alle Projekte</button>

@if (anlagen != null)
{
    <table class="table">
        <thead>
            <tr>
                <th>Project ID</th>
                <th>Project Name</th>
                <th>Anlagen</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var project in projects)
            {
                var projectAnlagen = anlagen.Where(a => a.ProjectId == project.ProjectId);
                <tr>
                    <td>@project.ProjectId</td>
                    <td>@project.ProjectName</td>
                    <td>
                        <ul>
                            @foreach (var anlage in projectAnlagen)
                            {
                                <li>ID: @anlage.AnlageId, Name: @anlage.AnlageName</li>
                            }
                        </ul>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private int projectId;
    private int anlageId;
    private int oldAnlageId;
    private IEnumerable<ProjectAnlageDto> anlagen;
    private IEnumerable<ProjectWithAnlagenDto> allAnlagen;
    private IEnumerable<Project> projects;
    private IEnumerable<AnlageDto> anlagenList;

    private bool alle = false;

    protected override async Task OnInitializedAsync()
    {
        projects = await ProjectService.GetActiveProjectsAsync();
        anlagenList = await ProjectAnlageService.GetAllAnlagen();
    }


    private async Task AssignAnlage()
    {
        await ProjectAnlageService.AssignAnlageToProject(new AssignAnlageToProjectDto { ProjectId = projectId, AnlageId = anlageId });
    }

    private async Task UpdateAnlage()
    {
        await ProjectAnlageService.UpdateAssignment(new UpdateProjectAnlageDto { ProjectId = projectId, OldAnlageId = oldAnlageId, NewAnlageId = anlageId });
    }

    private async Task RemoveAnlage()
    {
        await ProjectAnlageService.RemoveAssignment(projectId, anlageId);
    }

    private async Task GetProjectAnlage()
    {
        anlagen = await ProjectAnlageService.GetAnlagenForProject(projectId);
        alle = false;
    }

    private async Task GetAllProjectAnlagen()
    {
        allAnlagen = await ProjectAnlageService.GetAllProjectAnlagen();
        alle = true;
    }
}