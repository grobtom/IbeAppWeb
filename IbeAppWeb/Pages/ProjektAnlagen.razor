@page "/project-anlage"
@using IbeAppWeb.DTOs
@using IbeAppWeb.Services
@using Syncfusion.Blazor.DropDowns
@inject ProjectAnlageService ProjectAnlageService
@inject ProjectService ProjectService

<h3>Project Anlage Management</h3>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

<div class="col-lg-4 control-section sb-property-border">
    <div class="control-wrapper">
        <label class="example-label">Wähle Projekt:</label>
        <SfComboBox TValue="int" TItem="Project" PopupHeight="230px" Placeholder="Projekt" @bind-Value="@projectId" DataSource="@projects">
            <ComboBoxEvents TValue="int" TItem="Project" ValueChange="OnChange" />
            <ComboBoxFieldSettings Text="ProjectName" Value="ProjectId" />
        </SfComboBox>
    </div>
</div>

<div class="col-lg-4 control-section sb-property-border">
    <div class="control-wrapper">
        <label class="example-label">Bestehende Anlage:</label>
        <SfComboBox TValue="int" TItem="ProjectAnlageDto" PopupHeight="230px" Placeholder="Anlage" @bind-Value="@oldAnlageId" DataSource="@anlagen">
            <ComboBoxEvents TValue="int" TItem="ProjectAnlageDto" />
            <ComboBoxFieldSettings Text="AnlageName" Value="AnlageId" />
        </SfComboBox>
    </div>
</div>

<div class="col-lg-4 control-section sb-property-border">
    <div class="control-wrapper">
        <label class="example-label">Neue Anlage:</label>
        <SfComboBox TValue="int" TItem="AnlageDto" PopupHeight="230px" Placeholder="Anlage" @bind-Value="@newAnlageId" DataSource="@anlagenList">
            <ComboBoxEvents TValue="int" TItem="AnlageDto" />
            <ComboBoxFieldSettings Text="AnlageName" Value="AnlageId" />
        </SfComboBox>
    </div>
</div>

<button @onclick="AssignAnlage">Anlage Zuordnen</button>
<button @onclick="UpdateAnlage">Update Zuordnung</button>
<button @onclick="RemoveAnlage">Lösche Zuordnung</button>
<button @onclick="GetAllProjectAnlagen">Zeige alle Projekte</button>

@if (anlagen != null)
{
    <table class="table">
        <thead>
            <tr>
                <th>Project ID</th>
                <th>Project Name</th>
                <th>Anlagen</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var project in projects)
            {
                var projectAnlagen = anlagen.Where(a => a.ProjectId == project.ProjectId);
                <tr>
                    <td>@project.ProjectId</td>
                    <td>@project.ProjectName</td>
                    <td>
                        <ul>
                            @foreach (var anlage in projectAnlagen)
                            {
                                <li>ID: @anlage.AnlageId, Name: @anlage.AnlageName</li>
                            }
                        </ul>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private int projectId;
    private int oldAnlageId;
    private int newAnlageId;
    private string errorMessage;    
    private IEnumerable<ProjectAnlageDto> anlagen;
    private IEnumerable<ProjectWithAnlagenDto> allAnlagen;
    private IEnumerable<Project> projects;
    private IEnumerable<AnlageDto> anlagenList;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            projects = await ProjectService.GetActiveProjectsAsync();
            anlagenList = await ProjectAnlageService.GetAllAnlagen();
        }
        catch (Exception ex)
        {
            errorMessage = $"Fehler beim Laden der Daten: {ex.Message}";
        }
    }


    private async Task AssignAnlage()
    {
        try
        {
            if (newAnlageId > 0 && projectId > 0)
            {
                await ProjectAnlageService.AssignAnlageToProject(new AssignAnlageToProjectDto { ProjectId = projectId, AnlageId = newAnlageId });
                await GetProjectAnlage();
            }
            else
            {
                errorMessage = "Bitte wählen Sie sowohl ein Projekt als auch eine neue Anlage aus.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Fehler beim Zuweisen der Anlage: {ex.Message}";
        }
    }

    private async Task UpdateAnlage()
    {
        try
        {
            if (oldAnlageId > 0 && projectId > 0 && newAnlageId > 0)
            {
                await ProjectAnlageService.UpdateAssignment(new UpdateProjectAnlageDto { ProjectId = projectId, OldAnlageId = oldAnlageId, NewAnlageId = newAnlageId });
                await GetProjectAnlage();
            }
            else
            {
                errorMessage = "Bitte wählen Sie sowohl ein Projekt als auch eine bestehende Anlage aus.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Fehler beim Aktualisieren der Anlage: {ex.Message}";
        }
    }

    private async Task RemoveAnlage()
    {
        await ProjectAnlageService.RemoveAssignment(projectId, oldAnlageId);
        await GetProjectAnlage();
    }

    private async Task GetProjectAnlage()
    {
        anlagen = await ProjectAnlageService.GetAnlagenForProject(projectId);
        foreach (var anlage in anlagen)
        {
            Console.WriteLine($"AnlageId: {anlage.AnlageId}, AnlageName: {anlage.AnlageName}");
        }
    }

    private async Task GetAllProjectAnlagen()
    {
        allAnlagen = await ProjectAnlageService.GetAllProjectAnlagen();
    }

    private async Task OnProjectChanged(Microsoft.AspNetCore.Components.ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var selectedProjectId))
        {
            projectId = selectedProjectId;
            await GetProjectAnlage(); // Load Anlagen for the selected project
        }
    }

    private async Task OnChange(ChangeEventArgs<int, Project> args)
    {
        projectId = args.Value; // Update the selected project ID
        await GetProjectAnlage(); // Load Anlagen for the selected project
    }

}